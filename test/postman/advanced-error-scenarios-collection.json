{
  "info": {
    "name": "TMI Advanced Error Scenarios",
    "description": "Advanced error scenarios including 422, 409, and edge cases",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{token_alice}}",
        "type": "string"
      }
    ]
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://127.0.0.1:8080"
    },
    {
      "key": "oauthStubUrl",
      "value": "http://127.0.0.1:8079"
    },
    {
      "key": "testThreatModelId",
      "value": ""
    },
    {
      "key": "testDiagramId",
      "value": ""
    }
  ],
  "item": [
    {
      "name": "Setup",
      "item": [
        {
          "name": "Create Test Threat Model",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Save threat model ID for error tests', function () {",
                  "    const responseData = pm.response.json();",
                  "    pm.expect(responseData).to.have.property('id');",
                  "    pm.collectionVariables.set('testThreatModelId', responseData.id);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"name\": \"Error Test TM\", \"description\": \"For error scenario testing\", \"threat_model_framework\": \"STRIDE\"}"
            },
            "url": {
              "raw": "{{baseUrl}}/threat_models",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "threat_models"
              ]
            }
          }
        },
        {
          "name": "Create Test Diagram",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Save diagram ID for error tests', function () {",
                  "    const responseData = pm.response.json();",
                  "    pm.expect(responseData).to.have.property('id');",
                  "    pm.collectionVariables.set('testDiagramId', responseData.id);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"name\": \"Error Test Diagram\", \"type\": \"DFD-1.0.0\"}"
            },
            "url": {
              "raw": "{{baseUrl}}/threat_models/{{testThreatModelId}}/diagrams",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "threat_models",
                "{{testThreatModelId}}",
                "diagrams"
              ]
            }
          }
        }
      ]
    },
    {
      "name": "422 Unprocessable Entity",
      "item": [
        {
          "name": "Invalid JSON Patch Operation (422)",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json-patch+json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "[{\"op\": \"invalid-operation\", \"path\": \"/name\", \"value\": \"test\"}]"
            },
            "url": {
              "raw": "{{baseUrl}}/threat_models/{{testThreatModelId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "threat_models",
                "{{testThreatModelId}}"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 422 or 400', function () {",
                  "    pm.expect([422, 400]).to.include(pm.response.code);",
                  "});",
                  "",
                  "pm.test('Error response indicates invalid operation', function () {",
                  "    const responseText = pm.response.text().toLowerCase();",
                  "    pm.expect(responseText).to.match(/(invalid|unsupported|unknown|bad)/);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "409 Conflict",
      "item": [
        {
          "name": "Start First Collaboration Session",
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/threat_models/{{testThreatModelId}}/diagrams/{{testDiagramId}}/collaborate",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "threat_models",
                "{{testThreatModelId}}",
                "diagrams",
                "{{testDiagramId}}",
                "collaborate"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('First session created successfully', function () {",
                  "    pm.expect([200, 201]).to.include(pm.response.code);",
                  "});",
                  "",
                  "pm.test('Response has session info', function () {",
                  "    if (pm.response.code === 200 || pm.response.code === 201) {",
                  "        const responseData = pm.response.json();",
                  "        pm.expect(responseData).to.have.property('websocket_url');",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Duplicate Collaboration Session (Idempotent - Returns Existing)",
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/threat_models/{{testThreatModelId}}/diagrams/{{testDiagramId}}/collaborate",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "threat_models",
                "{{testThreatModelId}}",
                "diagrams",
                "{{testDiagramId}}",
                "collaborate"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "// API is idempotent - returns existing session on duplicate request",
                  "pm.test('Status code is 200 OK (idempotent)', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Returns existing session info', function () {",
                  "    const responseData = pm.response.json();",
                  "    pm.expect(responseData).to.have.property('websocket_url');",
                  "    pm.expect(responseData).to.have.property('diagram_id');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "End Collaboration Session",
          "request": {
            "method": "DELETE",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/threat_models/{{testThreatModelId}}/diagrams/{{testDiagramId}}/collaborate",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "threat_models",
                "{{testThreatModelId}}",
                "diagrams",
                "{{testDiagramId}}",
                "collaborate"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Session ended successfully', function () {",
                  "    pm.expect([200, 204]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "500 Server Errors",
      "item": [
        {
          "name": "Large Payload Test",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"name\": \"Large Payload Test\", \"description\": \"This is a large payload test with a very long description that repeats many times to test server handling of large requests. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum. This is a large payload test with a very long description that repeats many times to test server handling of large requests. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.\", \"threat_model_framework\": \"STRIDE\"}"
            },
            "url": {
              "raw": "{{baseUrl}}/threat_models",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "threat_models"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is not 500', function () {",
                  "    pm.expect(pm.response.code).to.not.equal(500);",
                  "});",
                  "",
                  "pm.test('Server handles large payload gracefully', function () {",
                  "    pm.expect([200, 201, 400, 413]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Cleanup",
      "item": [
        {
          "name": "Delete Test Threat Model",
          "request": {
            "method": "DELETE",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/threat_models/{{testThreatModelId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "threat_models",
                "{{testThreatModelId}}"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Cleanup successful', function () {",
                  "    // 409 can happen if collaboration session wasn't ended",
                  "    pm.expect([200, 204, 404, 409]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    }
  ]
}