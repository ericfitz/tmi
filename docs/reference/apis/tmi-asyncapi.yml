asyncapi: "3.0.0"

info:
  title: TMI WebSocket API
  version: "1.0.0"
  contact:
    name: TMI Project
    url: https://github.com/ericfitz/tmi
    email: support@tmi.dev
  license:
    name: Apache-2.0
    url: https://www.apache.org/licenses/LICENSE-2.0
  tags:
    - name: collaboration
      description: Real-time collaborative editing operations
    - name: diagrams
      description: Diagram manipulation and state management
  description: |
    AsyncAPI specification for the Collaborative Threat Modeling Interface (TMI) WebSocket messaging.
    This API enables real-time collaborative editing of threat model diagrams with role-based access control.

    ## Features
    - Real-time collaborative diagram editing
    - Role-based access control (reader/writer/owner permissions)
    - JWT token authentication
    - Session management with automatic cleanup
    - Diagram operation validation

    ## Connection Flow
    1. Authenticate with JWT token
    2. Validate access permissions for the diagram
    3. Join or create collaboration session
    4. Exchange real-time diagram operations
    5. Receive join/leave notifications from other participants

servers:
  development:
    host: localhost:8080
    protocol: ws
    description: Local development server
    security:
      - $ref: '#/components/securitySchemes/jwtAuth'

  production:
    host: api.tmi.dev
    protocol: wss
    description: Production server with TLS
    security:
      - $ref: '#/components/securitySchemes/jwtAuth'

channels:
  "/threat_models/{threat_model_id}/diagrams/{diagram_id}/ws":
    address: "/threat_models/{threat_model_id}/diagrams/{diagram_id}/ws"
    description: |
      WebSocket endpoint for collaborative diagram editing. Each diagram has its own collaboration session.
      Users must have at least reader permissions on the parent threat model to connect.

      ## Session Management
      - Sessions are automatically created when first client connects
      - Sessions include automatic cleanup after 15 minutes of inactivity
      - Multiple clients can participate in the same session simultaneously
      - Each session tracks active participants and their join times
    parameters:
      threat_model_id:
        description: Unique identifier of the threat model (UUID format, matches OpenAPI path parameter)
      diagram_id:
        description: Unique identifier of the diagram (UUID format)
    messages:
      diagramOperationRequestMessage:
        $ref: "#/components/messages/DiagramOperationRequestMessage"
      diagramOperationEventMessage:
        $ref: "#/components/messages/DiagramOperationEventMessage"
      presenterRequestMessage:
        $ref: "#/components/messages/PresenterRequestMessage"
      presenterRequestEventMessage:
        $ref: "#/components/messages/PresenterRequestEventMessage"
      presenterDeniedRequestMessage:
        $ref: "#/components/messages/PresenterDeniedRequestMessage"
      presenterDeniedEventMessage:
        $ref: "#/components/messages/PresenterDeniedEventMessage"
      changePresenterRequestMessage:
        $ref: "#/components/messages/ChangePresenterRequestMessage"
      presenterCursorMessage:
        $ref: "#/components/messages/PresenterCursorMessage"
      presenterSelectionMessage:
        $ref: "#/components/messages/PresenterSelectionMessage"
      authorizationDeniedMessage:
        $ref: "#/components/messages/AuthorizationDeniedMessage"
      syncStatusRequestMessage:
        $ref: "#/components/messages/SyncStatusRequestMessage"
      syncStatusResponseMessage:
        $ref: "#/components/messages/SyncStatusResponseMessage"
      syncRequestMessage:
        $ref: "#/components/messages/SyncRequestMessage"
      diagramStateMessage:
        $ref: "#/components/messages/DiagramStateMessage"
      undoRequestMessage:
        $ref: "#/components/messages/UndoRequestMessage"
      redoRequestMessage:
        $ref: "#/components/messages/RedoRequestMessage"
      participantsUpdateMessage:
        $ref: "#/components/messages/ParticipantsUpdateMessage"
      removeParticipantRequestMessage:
        $ref: "#/components/messages/RemoveParticipantRequestMessage"
      errorMessage:
        $ref: "#/components/messages/ErrorMessage"
      operationRejectedMessage:
        $ref: "#/components/messages/OperationRejectedMessage"

operations:
  sendDiagramOperation:
    action: send
    channel:
      $ref: "#/channels/~1threat_models~1{threat_model_id}~1diagrams~1{diagram_id}~1ws"
    summary: Send a diagram operation (client to server)
    description: |
      Send a diagram operation request (add, update, or remove) to be applied to the diagram
      and broadcasted to all connected participants. Client-to-server messages use Request types
      without initiating_user field (server uses authenticated context).

      ## Rate Limits
      - Message size limit: 4KB per message
      - Operation size limit: 50KB per operation
      - Write timeout: 10 seconds per message
    messages:
      - $ref: "#/components/messages/DiagramOperationRequestMessage"
      - $ref: "#/components/messages/PresenterRequestMessage"
      - $ref: "#/components/messages/ChangePresenterRequestMessage"
      - $ref: "#/components/messages/PresenterCursorMessage"
      - $ref: "#/components/messages/PresenterSelectionMessage"
      - $ref: "#/components/messages/PresenterDeniedRequestMessage"
      - $ref: "#/components/messages/SyncStatusRequestMessage"
      - $ref: "#/components/messages/SyncRequestMessage"
      - $ref: "#/components/messages/UndoRequestMessage"
      - $ref: "#/components/messages/RedoRequestMessage"
      - $ref: "#/components/messages/RemoveParticipantRequestMessage"

  receiveDiagramEvents:
    action: receive
    channel:
      $ref: "#/channels/~1threat_models~1{threat_model_id}~1diagrams~1{diagram_id}~1ws"
    summary: Receive diagram events (server to client)
    description: |
      Receive real-time events including diagram operations from other users and session updates.
      Server-to-client messages use Event types with initiating_user field showing who triggered the action.

      ## Connection Management
      - Read timeout: 60 seconds with ping/pong keepalive
      - Automatic reconnection recommended for production clients
      - Sessions persist for up to 15 minutes after last activity

      ## Participant Tracking
      - participants_update message provides complete participant list
      - host field contains full User object for the session host
      - current_presenter field contains User object or null if no presenter
    messages:
      - $ref: "#/components/messages/DiagramOperationEventMessage"
      - $ref: "#/components/messages/PresenterDeniedEventMessage"
      - $ref: "#/components/messages/PresenterCursorMessage"
      - $ref: "#/components/messages/PresenterSelectionMessage"
      - $ref: "#/components/messages/AuthorizationDeniedMessage"
      - $ref: "#/components/messages/SyncStatusResponseMessage"
      - $ref: "#/components/messages/DiagramStateMessage"
      - $ref: "#/components/messages/ParticipantsUpdateMessage"
      - $ref: "#/components/messages/ErrorMessage"
      - $ref: "#/components/messages/OperationRejectedMessage"

components:
  parameters:
    ThreatModelId:
      description: Unique identifier of the threat model (UUID format)

    DiagramId:
      description: Unique identifier of the diagram (UUID format)

  messages:
    DiagramOperationRequestMessage:
      name: DiagramOperationRequestMessage
      title: Diagram Operation Request (Client → Server)
      summary: Client request to perform diagram operation
      description: |
        Client-to-server request for collaborative editing operations. Supports batch operations,
        sequence numbers for conflict resolution, and operation IDs for idempotency.
        Client does not send initiating_user - server uses authenticated client context.
      payload:
        $ref: "#/components/schemas/DiagramOperationRequestPayload"
      examples:
        - name: BatchCellOperations
          summary: Example of batch cell operations request
          payload:
            message_type: diagram_operation_request
            operation_id: 123e4567-e89b-12d3-a456-426614174000
            base_vector: 42
            operation:
              type: patch
              cells:
                - id: cell-uuid-1
                  operation: add
                  data:
                    id: cell-uuid-1
                    shape: process
                    x: 100
                    y: 150
                    width: 120
                    height: 80
                    label: User Authentication
                - id: cell-uuid-2
                  operation: update
                  data:
                    x: 110
                    y: 160
                    label: Updated Process

    DiagramOperationEventMessage:
      name: DiagramOperationEventMessage
      title: Diagram Operation Event (Server → Client)
      summary: Server broadcasts diagram operation with initiating user
      description: |
        Server-to-client broadcast of diagram operations. Includes initiating_user to show
        who triggered the operation. Server assigns sequence_number for ordering.
      payload:
        $ref: "#/components/schemas/DiagramOperationEventPayload"
      examples:
        - name: BatchCellOperations
          summary: Example of broadcast diagram operation event
          payload:
            message_type: diagram_operation_event
            initiating_user:
              principal_type: user
              provider: google
              provider_id: "101155414856250184779"
              email: alice@example.com
              display_name: Alice Johnson
            operation_id: 123e4567-e89b-12d3-a456-426614174000
            sequence_number: 12345
            update_vector: 43
            operation:
              type: patch
              cells:
                - id: cell-uuid-1
                  operation: add
                  data:
                    id: cell-uuid-1
                    shape: process
                    x: 100
                    y: 150
                    width: 120
                    height: 80
                    label: User Authentication
                - id: cell-uuid-2
                  operation: update
                  data:
                    x: 110
                    y: 160
                    label: Updated Process

    PresenterRequestMessage:
      name: PresenterRequestMessage
      title: Presenter Request (Client → Server)
      summary: Request to become the active presenter
      description: |
        Client-to-server request to become the active presenter. Client does not send
        requesting_user - server uses authenticated client context. Only the session
        host can approve presenter requests.
      payload:
        $ref: "#/components/schemas/PresenterRequestPayload"
      examples:
        - name: RequestPresenter
          summary: Example of requesting presenter mode
          payload:
            message_type: presenter_request

    PresenterRequestEventMessage:
      name: PresenterRequestEventMessage
      title: Presenter Request Event (Server → Host)
      summary: Server notifies host of presenter request
      description: |
        Server-to-host event sent when a participant requests to become the presenter.
        Only sent to the session host for approval. Includes requesting_user populated
        from authenticated client context (not client-asserted).
      payload:
        $ref: "#/components/schemas/PresenterRequestEventPayload"
      examples:
        - name: PresenterRequestEvent
          summary: Example of presenter request notification to host
          payload:
            message_type: presenter_request_event
            requesting_user:
              principal_type: user
              provider: google
              provider_id: alice@example.com
              email: alice@example.com
              display_name: Alice Johnson

    PresenterDeniedRequestMessage:
      name: PresenterDeniedRequestMessage
      title: Presenter Denied Request (Host → Server)
      summary: Host requests to deny a presenter request
      description: |
        Client-to-server request sent by the host to deny a participant's presenter request.
        Only accepted from session host (validated via authenticated connection context).
        Client sends denied_user to identify target; server validates and forwards event.
      payload:
        $ref: "#/components/schemas/PresenterDeniedRequestPayload"
      examples:
        - name: PresenterDeniedRequest
          summary: Example of host denying presenter request
          payload:
            message_type: presenter_denied_request
            denied_user:
              principal_type: user
              provider: google
              provider_id: "101155414856250184779"
              email: alice@example.com
              display_name: Alice Johnson

    PresenterDeniedEventMessage:
      name: PresenterDeniedEventMessage
      title: Presenter Denied Event (Server → Requester)
      summary: Server notifies user their presenter request was denied
      description: |
        Server-to-client event sent to the user whose presenter request was denied.
        Only sent to the denied user on their connection. Includes denied_user populated
        from the target client's authenticated context (not client-asserted).
      payload:
        $ref: "#/components/schemas/PresenterDeniedEventPayload"
      examples:
        - name: PresenterDeniedEvent
          summary: Example of presenter denial notification
          payload:
            message_type: presenter_denied_event
            denied_user:
              principal_type: user
              provider: google
              provider_id: "101155414856250184779"
              email: alice@example.com
              display_name: Alice Johnson

    ChangePresenterRequestMessage:
      name: ChangePresenterRequestMessage
      title: Change Presenter Request (Client → Server)
      summary: Host requests to change the active presenter
      description: |
        Client-to-server request by host to change the active presenter. Only accepted
        from the session host. Client does not send initiating_user - server uses
        authenticated client context. Server validates new_presenter refers to connected user.
      payload:
        $ref: "#/components/schemas/ChangePresenterRequestPayload"
      examples:
        - name: ChangePresenterRequest
          summary: Example of host changing presenter
          payload:
            message_type: change_presenter_request
            new_presenter:
              principal_type: user
              provider: google
              provider_id: "101155414856250184779"
              email: alice@example.com
              display_name: Alice Johnson

    PresenterCursorMessage:
      name: PresenterCursorMessage
      title: Presenter Cursor Position
      summary: Cursor position from active presenter
      description: |
        Message sent by active presenter to share cursor position with all participants.
        Only the current presenter should send these messages.
      payload:
        $ref: "#/components/schemas/PresenterCursorPayload"
      examples:
        - name: PresenterCursor
          summary: Example of presenter cursor position
          payload:
            message_type: presenter_cursor
            cursor_position:
              x: 100
              y: 200

    PresenterSelectionMessage:
      name: PresenterSelectionMessage
      title: Presenter Selection State
      summary: Selection state from active presenter
      description: |
        Message sent by active presenter to share selection state with all participants.
        Only the current presenter should send these messages.
      payload:
        $ref: "#/components/schemas/PresenterSelectionPayload"
      examples:
        - name: PresenterSelection
          summary: Example of presenter selection
          payload:
            message_type: presenter_selection
            selected_cells:
              - cell-uuid-1
              - cell-uuid-2

    AuthorizationDeniedMessage:
      name: AuthorizationDeniedMessage
      title: Authorization Denied
      summary: Notification that operation was denied due to insufficient permissions
      description: |
        Message sent to users who attempt operations they don't have permission for.
        Includes the original operation ID for client tracking.
      payload:
        $ref: "#/components/schemas/AuthorizationDeniedPayload"
      examples:
        - name: AuthorizationDenied
          summary: Example of authorization denial
          payload:
            message_type: authorization_denied
            original_operation_id: 123e4567-e89b-12d3-a456-426614174000
            reason: insufficient_permissions

    SyncStatusRequestMessage:
      name: SyncStatusRequestMessage
      title: Sync Status Request (Client → Server)
      summary: Client asks server for current update vector
      description: |
        Client-to-server request to check the server's current update vector without
        receiving full diagram state. Useful when client suspects state drift and wants
        to verify synchronization status before deciding whether to request full state.

        ## Use Case
        Client can send this message when reconnecting or after a period of inactivity
        to quickly check if their local state is current without the overhead of
        receiving the full diagram state.

        ## Response
        Server responds with SyncStatusResponseMessage containing the current update_vector.
      payload:
        $ref: "#/components/schemas/SyncStatusRequestPayload"
      examples:
        - name: CheckSyncStatus
          summary: Check if client state is current
          payload:
            message_type: sync_status_request

    SyncStatusResponseMessage:
      name: SyncStatusResponseMessage
      title: Sync Status Response (Server → Client)
      summary: Server responds with current update vector
      description: |
        Server-to-client response containing only the current update vector.
        Sent in response to SyncStatusRequestMessage, or as a response to
        SyncRequestMessage when the client's update_vector matches the server's.

        ## Client Handling
        Compare the returned update_vector with local state:
        - If equal: Client is synchronized, no action needed
        - If different: Send SyncRequestMessage to get full diagram state
      payload:
        $ref: "#/components/schemas/SyncStatusResponsePayload"
      examples:
        - name: SyncStatusResponse
          summary: Server reports current update vector
          payload:
            message_type: sync_status_response
            update_vector: 42

    SyncRequestMessage:
      name: SyncRequestMessage
      title: Sync Request (Client → Server)
      summary: Client requests full diagram state if stale
      description: |
        Client-to-server request for full diagram state. Includes optional update_vector
        for conditional synchronization.

        ## Conditional Sync
        - If update_vector is provided and matches server's: Server sends SyncStatusResponseMessage
        - If update_vector is provided and differs: Server sends DiagramStateMessage
        - If update_vector is omitted or null: Server always sends DiagramStateMessage

        ## Use Case
        Send after receiving SyncStatusResponseMessage with a different update_vector,
        or when client detects potential state drift and wants to ensure synchronization.
      payload:
        $ref: "#/components/schemas/SyncRequestPayload"
      examples:
        - name: ConditionalSyncRequest
          summary: Request state if stale (with update_vector)
          payload:
            message_type: sync_request
            update_vector: 40
        - name: ForceSyncRequest
          summary: Request full state unconditionally
          payload:
            message_type: sync_request

    DiagramStateMessage:
      name: DiagramStateMessage
      title: Diagram State (Server → Client)
      summary: Server sends complete diagram state
      description: |
        Full diagram state sent by the server. Used for:

        ## Initial Connection
        Sent immediately after a client successfully joins a WebSocket session,
        before the participants_update message.

        ## Response to SyncRequestMessage
        Sent when client requests full state and their update_vector differs from
        the server's (or is omitted).

        ## Contents
        Contains the complete diagram state including:
        - diagram_id: UUID of the diagram
        - update_vector: Current authoritative version number
        - cells: Array of all diagram cells (nodes and edges)

        ## Client Handling
        1. Replace local diagram state with received state
        2. Update local update_vector to track future operations
        3. If cells array is empty, the diagram has no cells yet

        ## Performance Considerations
        For diagrams with many cells (100+), this message may be large. Clients
        should handle asynchronously if needed.
      payload:
        $ref: "#/components/schemas/DiagramStatePayload"
      examples:
        - name: DiagramStateWithCells
          summary: Diagram state with existing cells
          payload:
            message_type: diagram_state
            diagram_id: 6ba7b810-9dad-11d1-80b4-00c04fd430c8
            update_vector: 42
            cells:
              - id: 123e4567-e89b-12d3-a456-426614174000
                shape: process
                x: 100
                y: 100
                width: 120
                height: 60
                label: Authentication Service
              - id: 987fcdeb-51a2-43f7-8a9b-426614174000
                shape: edge
                source: 123e4567-e89b-12d3-a456-426614174000
                target: 456e7890-abcd-12d3-a456-426614174000
        - name: DiagramStateEmpty
          summary: Diagram state for new diagram with no cells
          payload:
            message_type: diagram_state
            diagram_id: 6ba7b810-9dad-11d1-80b4-00c04fd430c8
            update_vector: 1
            cells: []

    UndoRequestMessage:
      name: UndoRequestMessage
      title: Undo Request (Client → Server)
      summary: Client requests undo operation
      description: |
        Client-to-server request to undo the last operation. Requires mutation permissions.
        Client does not send initiating_user - server uses authenticated client context.
        Server responds with DiagramOperationEvent showing the undone operation.
      payload:
        $ref: "#/components/schemas/UndoRequestPayload"
      examples:
        - name: UndoRequest
          summary: Example of undo request
          payload:
            message_type: undo_request

    RedoRequestMessage:
      name: RedoRequestMessage
      title: Redo Request (Client → Server)
      summary: Client requests redo operation
      description: |
        Client-to-server request to redo the last undone operation. Requires mutation permissions.
        Client does not send initiating_user - server uses authenticated client context.
        Server responds with DiagramOperationEvent showing the redone operation.
      payload:
        $ref: "#/components/schemas/RedoRequestPayload"
      examples:
        - name: RedoRequest
          summary: Example of redo request
          payload:
            message_type: redo_request

    RemoveParticipantRequestMessage:
      name: RemoveParticipantRequestMessage
      title: Remove Participant Request (Client → Server)
      summary: Host requests to remove a participant from collaboration session
      description: |
        Client-to-server request by the host to remove a specific participant from the collaboration session.
        Only the host can send this message. Client does not send initiating_user - server uses
        authenticated client context. Server validates removed_user refers to valid user.
        When processed, the server will:
        1. Disconnect the specified user from the current session
        2. Add the user to a session-specific deny list
        3. Broadcast a participants_update message to all remaining participants

        The removed participant will not be able to rejoin the same session but can
        participate in other collaboration sessions.
      payload:
        $ref: "#/components/schemas/RemoveParticipantRequestPayload"
      examples:
        - name: HostRemovesParticipant
          summary: Example of host removing a participant
          payload:
            message_type: remove_participant_request
            removed_user:
              principal_type: user
              provider: google
              provider_id: "disruptive-user-id"
              email: disruptive-user@example.com
              display_name: Disruptive User

    ErrorMessage:
      name: ErrorMessage
      title: Error Message
      summary: General error message for WebSocket errors
      description: |
        Sent when WebSocket errors occur such as authentication failures,
        session errors, or other operational errors. Follows the standard
        message_type pattern with additional error details.
      payload:
        $ref: "#/components/schemas/ErrorPayload"
      examples:
        - name: UnauthorizedError
          summary: Example of unauthorized access error
          payload:
            message_type: error
            error: unauthorized
            message: You don't have sufficient permissions to collaborate on this diagram
            code: insufficient_permissions
            timestamp: "2024-01-15T14:30:00Z"
        - name: SessionInvalidError
          summary: Example of invalid session error
          payload:
            message_type: error
            error: session_invalid
            message: The collaboration session ID is invalid or expired
            code: session_mismatch
            details:
              new_session_id: 6ba7b810-9dad-11d1-80b4-00c04fd430c8
            timestamp: "2024-01-15T14:35:00Z"

    OperationRejectedMessage:
      name: OperationRejectedMessage
      title: Operation Rejected Message
      summary: Notification sent to operation originator when operation is rejected
      description: |
        Sent exclusively to the client that originated a diagram operation when
        the server rejects the operation due to validation failure, conflicts,
        or other reasons. This provides explicit feedback to the originating
        client that their operation was not applied or broadcast.

        **Key behaviors:**
        - Only sent to the originating client (never broadcast to others)
        - Includes the original operation_id for correlation
        - Provides structured reason codes for programmatic handling
        - May include the sequence number if one was assigned before rejection

        **Reason codes:**
        - `validation_failed`: Operation structure or data failed validation
        - `conflict_detected`: Operation conflicts with current diagram state
        - `no_state_change`: Operation would result in no actual state change (idempotent no-op)
        - `diagram_not_found`: Target diagram no longer exists
        - `permission_denied`: User lacks permission for this operation
        - `invalid_operation_type`: Operation type is not recognized
        - `empty_operation`: Operation contains no cell operations
      payload:
        $ref: "#/components/schemas/OperationRejectedPayload"
      examples:
        - name: ConflictDetected
          summary: Operation rejected due to concurrent modification conflict
          payload:
            message_type: operation_rejected
            operation_id: 123e4567-e89b-12d3-a456-426614174000
            sequence_number: 12345
            update_vector: 43
            reason: conflict_detected
            message: Cell 'cell-uuid-1' was modified by another user before your operation could be applied
            affected_cells:
              - cell-uuid-1
            requires_resync: true
            timestamp: "2024-01-15T14:30:00Z"
        - name: ValidationFailed
          summary: Operation rejected due to invalid data
          payload:
            message_type: operation_rejected
            operation_id: 789e4567-e89b-12d3-a456-426614174999
            update_vector: 42
            reason: validation_failed
            message: Cell operation validation failed - cell ID mismatch
            details: "cell data ID (cell-uuid-1) must match operation ID (cell-uuid-2)"
            requires_resync: false
            timestamp: "2024-01-15T14:32:00Z"
        - name: NoStateChange
          summary: Operation rejected because it would result in no state change
          payload:
            message_type: operation_rejected
            operation_id: 456e4567-e89b-12d3-a456-426614174333
            sequence_number: 12346
            update_vector: 43
            reason: no_state_change
            message: Operation resulted in no state changes (idempotent or no-op)
            requires_resync: false
            timestamp: "2024-01-15T14:33:00Z"

    ParticipantsUpdateMessage:
      name: ParticipantsUpdateMessage
      title: Participants Update Event (Server → Client)
      summary: Complete list of session participants with roles
      description: |
        Server-to-client event sent to all participants whenever the participant list changes.
        Provides a complete snapshot of all current participants, their permissions, and
        roles (host, presenter).

        The host and current_presenter fields contain full User objects to enable clients
        to properly display user names and match users by ID or email.

        This eliminates the need for clients to poll the REST API for participant information.
      payload:
        $ref: "#/components/schemas/ParticipantsUpdatePayload"
      examples:
        - name: UserJoinedEvent
          summary: Example of participants update after user joined
          payload:
            message_type: participants_update
            participants:
              - user:
                  principal_type: user
                  provider: google
                  provider_id: "101155414856250184779"
                  email: alice@example.com
                  display_name: Alice Johnson
                permissions: writer
                last_activity: "2024-01-15T10:30:00Z"
              - user:
                  principal_type: user
                  provider: google
                  provider_id: "109876543210987654321"
                  email: bob@example.com
                  display_name: Bob Smith
                permissions: reader
                last_activity: "2024-01-15T10:35:00Z"
            host:
              principal_type: user
              provider: google
              provider_id: "101155414856250184779"
              email: alice@example.com
              display_name: Alice Johnson
            current_presenter:
              principal_type: user
              provider: google
              provider_id: "109876543210987654321"
              email: bob@example.com
              display_name: Bob Smith
        - name: NoPresenterEvent
          summary: Example of participants update with no current presenter
          payload:
            message_type: participants_update
            participants:
              - user:
                  principal_type: user
                  provider: google
                  provider_id: "101155414856250184779"
                  email: alice@example.com
                  display_name: Alice Johnson
                permissions: writer
                last_activity: "2024-01-15T10:30:00Z"
            host:
              principal_type: user
              provider: google
              provider_id: "101155414856250184779"
              email: alice@example.com
              display_name: Alice Johnson
            current_presenter: null

  schemas:
    DiagramOperationRequestPayload:
      type: object
      description: Client-to-server request payload for diagram operations
      properties:
        message_type:
          type: string
          const: diagram_operation_request
        operation_id:
          type: string
          format: uuid
          description: Client-generated UUID for idempotency and tracking
          example: 123e4567-e89b-12d3-a456-426614174000
        base_vector:
          type: integer
          format: int64
          minimum: 0
          description: |
            Client's current update_vector when operation was created.
            Used for conflict detection - if server's update_vector is higher
            and the same cells are affected, the operation may be rejected.
          example: 42
        operation:
          $ref: "#/components/schemas/CellPatchOperation"
      required:
        - message_type
        - operation_id
        - base_vector
        - operation
      additionalProperties: false

    DiagramOperationEventPayload:
      type: object
      description: Server-to-client broadcast payload for diagram operations
      properties:
        message_type:
          type: string
          const: diagram_operation_event
        initiating_user:
          $ref: "#/components/schemas/User"
        operation_id:
          type: string
          format: uuid
          description: Client-generated UUID for idempotency and tracking
          example: 123e4567-e89b-12d3-a456-426614174000
        sequence_number:
          type: integer
          description: Server-assigned sequence number for operation ordering within session
          minimum: 0
          example: 12345
        update_vector:
          type: integer
          format: int64
          minimum: 0
          description: |
            New diagram update_vector after this operation was applied.
            Clients should update their local update_vector to this value.
          example: 43
        operation:
          $ref: "#/components/schemas/CellPatchOperation"
      required:
        - message_type
        - initiating_user
        - operation_id
        - sequence_number
        - update_vector
        - operation
      additionalProperties: false

    User:
      type: object
      description: |
        User information from JWT claims. Authorization uses a two-step matching process:
        1. First attempts to match provider_id as IdP user identifier (OAuth sub, SAML NameID/subject-id/pairwise-id)
        2. Falls back to email matching if no IdP user ID match is found

        This approach prioritizes IdP-provided user identifiers while maintaining backward compatibility
        with email-based authorization.
      properties:
        principal_type:
          type: string
          enum: [user]
          description: Always "user" for User objects
          example: user
        provider:
          type: string
          description: Identity provider name (e.g., "google", "github", "microsoft", "tmi")
          example: google
        provider_id:
          type: string
          description: |
            Provider-assigned unique user identifier from JWT 'sub' claim.
            This is the preferred and immutable identifier for user authorization.
            Format varies by IdP: OAuth providers use 'sub' claim, SAML uses NameID/subject-id/pairwise-id.
          example: "101155414856250184779"
        email:
          type: string
          description: |
            User email address from JWT 'email' claim.
            Used as fallback identifier for authorization when IdP user ID matching fails.
          example: alice@example.com
        display_name:
          type: string
          description: User display name from JWT 'name' claim (optional)
          example: Alice Johnson
      required:
        - principal_type
        - provider
        - provider_id
        - email
        - display_name
      additionalProperties: false

    CellPatchOperation:
      type: object
      description: Mirrors REST PATCH operations for cells with batch support
      properties:
        type:
          type: string
          const: patch
        cells:
          type: array
          description: |
            Array of cell operations to perform.
            - For 'add' and 'update' operations, 'data' field is required
            - For 'remove' operations, 'data' field should be omitted
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
                description: Cell ID for the operation
              operation:
                type: string
                enum: [add, update, remove]
                description: Operation type to perform on the cell
              data:
                $ref: "#/components/schemas/Cell"
            required:
              - id
              - operation
          minItems: 1
      required:
        - type
        - cells
      additionalProperties: false

    Cell:
      type: object
      description: |
        Represents a diagram cell following AntV X6 structure.
        Cells can be either nodes (process, store, actor, etc.) or edges (connectors).
        See tmi-openapi.json for full Node and Edge schema definitions.
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the cell
        shape:
          type: string
          description: Cell type (e.g., process, store, actor, trust-boundary for nodes; edge for edges)
      required:
        - id
        - shape
      additionalProperties: true

    PresenterRequestPayload:
      type: object
      description: Client-to-server request to become the active presenter
      properties:
        message_type:
          type: string
          const: presenter_request
      required:
        - message_type
      additionalProperties: false

    PresenterRequestEventPayload:
      type: object
      description: Server-to-host event notifying of presenter request
      properties:
        message_type:
          type: string
          const: presenter_request_event
        requesting_user:
          $ref: "#/components/schemas/User"
          description: User requesting to become presenter (from authenticated context)
      required:
        - message_type
        - requesting_user
      additionalProperties: false

    PresenterDeniedRequestPayload:
      type: object
      description: Client-to-server request from host to deny a presenter request
      properties:
        message_type:
          type: string
          const: presenter_denied_request
        denied_user:
          $ref: "#/components/schemas/User"
          description: User whose presenter request should be denied (validated server-side)
      required:
        - message_type
        - denied_user
      additionalProperties: false

    PresenterDeniedEventPayload:
      type: object
      description: Server-to-client notification that presenter request was denied
      properties:
        message_type:
          type: string
          const: presenter_denied_event
        denied_user:
          $ref: "#/components/schemas/User"
          description: User whose presenter request was denied (from authenticated context)
      required:
        - message_type
        - denied_user
      additionalProperties: false

    ChangePresenterRequestPayload:
      type: object
      description: Client-to-server request to change the active presenter
      properties:
        message_type:
          type: string
          const: change_presenter_request
        new_presenter:
          $ref: "#/components/schemas/User"
          description: User to become new presenter (validated server-side)
      required:
        - message_type
        - new_presenter
      additionalProperties: false

    PresenterCursorPayload:
      type: object
      description: Cursor position from active presenter
      properties:
        message_type:
          type: string
          const: presenter_cursor
        cursor_position:
          type: object
          description: Cursor coordinates
          properties:
            x:
              type: number
              description: X coordinate
              example: 100
            y:
              type: number
              description: Y coordinate
              example: 200
          required:
            - x
            - y
          additionalProperties: false
      required:
        - message_type
        - cursor_position
      additionalProperties: false

    PresenterSelectionPayload:
      type: object
      description: Selection state from active presenter
      properties:
        message_type:
          type: string
          const: presenter_selection
        selected_cells:
          type: array
          description: Array of selected cell IDs
          items:
            type: string
            format: uuid
          example:
            - cell-uuid-1
            - cell-uuid-2
      required:
        - message_type
        - selected_cells
      additionalProperties: false

    AuthorizationDeniedPayload:
      type: object
      description: Notification of unauthorized operation attempt
      properties:
        message_type:
          type: string
          const: authorization_denied
        original_operation_id:
          type: string
          format: uuid
          description: Operation ID that was denied
          example: 123e4567-e89b-12d3-a456-426614174000
        reason:
          type: string
          description: Reason for denial
          enum: [insufficient_permissions, read_only_user, invalid_user]
          example: insufficient_permissions
      required:
        - message_type
        - original_operation_id
        - reason
      additionalProperties: false

    SyncStatusRequestPayload:
      type: object
      description: Client asks server for current update vector
      properties:
        message_type:
          type: string
          const: sync_status_request
      required:
        - message_type
      additionalProperties: false

    SyncStatusResponsePayload:
      type: object
      description: Server responds with current update vector only
      properties:
        message_type:
          type: string
          const: sync_status_response
        update_vector:
          type: integer
          format: int64
          minimum: 0
          description: Current authoritative update vector for the diagram
          example: 42
      required:
        - message_type
        - update_vector
      additionalProperties: false

    SyncRequestPayload:
      type: object
      description: |
        Client requests full diagram state if stale. If update_vector is provided
        and matches server's, server sends SyncStatusResponseMessage instead of
        full state. If omitted or different, server sends DiagramStateMessage.
      properties:
        message_type:
          type: string
          const: sync_request
        update_vector:
          type: integer
          format: int64
          minimum: 0
          nullable: true
          description: |
            Client's current update_vector. If provided and matches server's,
            server responds with SyncStatusResponseMessage. If omitted or different,
            server responds with DiagramStateMessage.
          example: 40
      required:
        - message_type
      additionalProperties: false

    DiagramStatePayload:
      type: object
      description: |
        Full diagram state sent by server on initial connection or in response
        to SyncRequestMessage when client is stale.
      properties:
        message_type:
          type: string
          const: diagram_state
        diagram_id:
          type: string
          format: uuid
          description: UUID of the diagram
          example: 6ba7b810-9dad-11d1-80b4-00c04fd430c8
        update_vector:
          type: integer
          format: int64
          minimum: 0
          description: Current authoritative update vector for the diagram
          example: 42
        cells:
          type: array
          description: Complete array of diagram cells (nodes and edges)
          items:
            $ref: "#/components/schemas/Cell"
          example:
            - id: 123e4567-e89b-12d3-a456-426614174000
              shape: process
              x: 100
              y: 100
            - id: 987fcdeb-51a2-43f7-8a9b-426614174000
              shape: edge
              source: 123e4567-e89b-12d3-a456-426614174000
              target: 456e7890-abcd-12d3-a456-426614174000
      required:
        - message_type
        - diagram_id
        - update_vector
        - cells
      additionalProperties: false

    UndoRequestPayload:
      type: object
      description: Client-to-server request to undo operation
      properties:
        message_type:
          type: string
          const: undo_request
      required:
        - message_type
      additionalProperties: false

    RedoRequestPayload:
      type: object
      description: Client-to-server request to redo operation
      properties:
        message_type:
          type: string
          const: redo_request
      required:
        - message_type
      additionalProperties: false

    ParticipantsUpdatePayload:
      type: object
      description: Server-to-client event with complete participant list
      properties:
        message_type:
          type: string
          const: participants_update
        participants:
          type: array
          description: List of all current participants
          items:
            type: object
            properties:
              user:
                $ref: "#/components/schemas/User"
              permissions:
                type: string
                enum: [reader, writer]
                description: User's permissions for the collaboration session
              last_activity:
                type: string
                format: date-time
                description: Last activity timestamp from the user
            required:
              - user
              - permissions
              - last_activity
        host:
          $ref: "#/components/schemas/User"
          description: User information for the session host
        current_presenter:
          anyOf:
            - $ref: "#/components/schemas/User"
            - type: "null"
          description: |
            User information for the current presenter.
            May be null if no presenter is currently assigned.
      required:
        - message_type
        - participants
        - host
      additionalProperties: false

    RemoveParticipantRequestPayload:
      type: object
      description: Client-to-server request to remove a participant from collaboration session
      properties:
        message_type:
          type: string
          const: remove_participant_request
        removed_user:
          $ref: "#/components/schemas/User"
          description: User to remove from session (validated server-side)
      required:
        - message_type
        - removed_user
      additionalProperties: false

    ErrorPayload:
      type: object
      description: General error message payload
      properties:
        message_type:
          type: string
          const: error
        error:
          type: string
          description: Error code/type
          example: unauthorized
        message:
          type: string
          description: Human-readable error message
          example: You don't have sufficient permissions to collaborate on this diagram
        code:
          type: string
          description: Optional specific error code for categorization
          example: insufficient_permissions
        details:
          type: object
          description: Optional additional error details
          additionalProperties: true
          example:
            new_session_id: 6ba7b810-9dad-11d1-80b4-00c04fd430c8
        timestamp:
          type: string
          format: date-time
          description: UTC timestamp when the error occurred
          example: "2024-01-15T14:30:00Z"
      required:
        - message_type
        - error
        - message
        - timestamp
      additionalProperties: false

    OperationRejectedPayload:
      type: object
      description: |
        Notification payload sent exclusively to the operation originator when
        their diagram operation is rejected. Provides structured feedback about
        why the operation was not applied or broadcast.
      properties:
        message_type:
          type: string
          const: operation_rejected
        operation_id:
          type: string
          format: uuid
          description: Client-generated operation ID from the rejected operation
          example: 123e4567-e89b-12d3-a456-426614174000
        sequence_number:
          type: integer
          description: Server-assigned sequence number (if assigned before rejection)
          minimum: 1
          example: 12345
        update_vector:
          type: integer
          format: int64
          minimum: 0
          description: |
            Current server update_vector when rejection occurred.
            Client can use this to determine if they need to resync.
          example: 43
        reason:
          type: string
          description: Structured reason code for the rejection
          enum:
            - validation_failed
            - conflict_detected
            - no_state_change
            - diagram_not_found
            - permission_denied
            - invalid_operation_type
            - empty_operation
          example: conflict_detected
        message:
          type: string
          description: Human-readable description of the rejection
          example: Cell 'cell-uuid-1' was modified by another user before your operation could be applied
        details:
          type: string
          description: Optional additional technical details about the rejection
          example: "cell data ID (cell-uuid-1) must match operation ID (cell-uuid-2)"
        affected_cells:
          type: array
          description: List of cell IDs affected by the rejected operation
          items:
            type: string
            format: uuid
          example:
            - cell-uuid-1
            - cell-uuid-2
        requires_resync:
          type: boolean
          description: |
            Indicates whether the client should perform a full state resync.
            - true: Conflict detected, client state may be out of sync (send sync_request)
            - false: Validation or no-op, client state is likely still valid
          example: true
        timestamp:
          type: string
          format: date-time
          description: UTC timestamp when the operation was rejected
          example: "2024-01-15T14:30:00Z"
      required:
        - message_type
        - operation_id
        - update_vector
        - reason
        - message
        - requires_resync
        - timestamp
      additionalProperties: false

  securitySchemes:
    jwtAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token authentication for WebSocket connections. Authentication is handled by 
        server-side middleware that validates JWT tokens provided as query parameters.

        ## Authentication Flow
        1. Client includes JWT token as query parameter: `?token=eyJ0eXAiOiJKV1Q...`
        2. Server middleware validates token and extracts user claims
        3. Server verifies user has at least reader access to the threat model
        4. Server verifies the diagram exists within the specified threat model
        5. WebSocket connection is established if all validations pass

        ## Access Control
        - Users need minimum reader permissions on the parent threat model
        - Diagram must exist within the specified threat model
        - Token must contain valid user identification claims (sub, email)

        Example: ws://localhost:8080/threat_models/123/diagrams/456/ws?token=eyJ0eXAiOiJKV1Q...
