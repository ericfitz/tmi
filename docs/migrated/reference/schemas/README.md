# Database & Data Schemas

<!-- MIGRATED: Content migrated to wiki. See verification summary below. -->

This directory contains database schema definitions, data models, and schema evolution documentation for the TMI project.

## Purpose

Index page for TMI data schemas. For authoritative schema documentation, see:
- **Wiki**: [[Database-Schema-Reference]] - Current, maintained documentation
- **GORM Models**: `api/models/models.go` - Single source of truth for all tables

## Files in this Directory

**Note**: The `database-schema-complete.md` file has been migrated to `docs/migrated/reference/schemas/` (superseded by wiki). See the wiki page [[Database-Schema-Reference]] for current, authoritative schema documentation.

The authoritative source for the database schema is now:
- **GORM Models**: `api/models/models.go` - Single source of truth for all tables
- **Wiki**: `Database-Schema-Reference.md` - Human-readable documentation
- **Legacy Migrations**: `docs/reference/legacy-migrations/` - Historical reference only

## Schema Categories

### Database Schemas
- **PostgreSQL Tables**: Complete table definitions with relationships
- **Constraints**: Primary keys, foreign keys, and business constraints
- **Indexes**: Performance optimization indexes and strategies
- **Migrations**: Schema evolution history and procedures
- **Views**: Computed views and reporting structures

### API Schemas
- **Request Schemas**: HTTP request body validation schemas
- **Response Schemas**: HTTP response structure definitions
- **Error Schemas**: Standardized error response formats
- **Query Parameter Schemas**: URL parameter validation rules
- **Header Schemas**: Required and optional header definitions

### Message Schemas
- **WebSocket Messages**: Real-time collaboration message formats
- **Event Schemas**: Domain event structure definitions
- **Command Schemas**: Command message format specifications
- **Notification Schemas**: System notification message formats
- **Protocol Schemas**: Communication protocol definitions

### Configuration Schemas
- **Application Config**: Server configuration file schemas
- **Database Config**: Database connection and setup schemas
- **OAuth Config**: Authentication provider configuration schemas
- **Environment Config**: Environment-specific configuration schemas
- **Deployment Config**: Container and orchestration configuration schemas

## Core Data Entities

### User Management
```sql
-- Users table with OAuth integration
users (
  internal_uuid UUID PRIMARY KEY,
  email TEXT NOT NULL,
  name TEXT NOT NULL,
  provider TEXT NOT NULL,
  provider_user_id TEXT NOT NULL,
  email_verified BOOLEAN DEFAULT FALSE,
  access_token TEXT,
  refresh_token TEXT,
  token_expiry TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  modified_at TIMESTAMPTZ DEFAULT NOW(),
  last_login TIMESTAMPTZ,
  UNIQUE(provider, provider_user_id)
);

-- Refresh token tracking for OAuth flows
refresh_tokens (
  id UUID PRIMARY KEY,
  user_internal_uuid UUID REFERENCES users(internal_uuid) ON DELETE CASCADE,
  token TEXT UNIQUE NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Threat Modeling
```sql
-- Threat models (top-level container)
threat_models (
  id UUID PRIMARY KEY,
  owner_internal_uuid UUID REFERENCES users(internal_uuid) ON DELETE RESTRICT,
  name TEXT NOT NULL,
  description TEXT,
  created_by_internal_uuid UUID REFERENCES users(internal_uuid) ON DELETE RESTRICT,
  threat_model_framework TEXT NOT NULL DEFAULT 'STRIDE'
    CHECK (threat_model_framework IN ('CIA', 'STRIDE', 'LINDDUN', 'DIE', 'PLOT4ai')),
  issue_uri TEXT,
  status TEXT CHECK (status IS NULL OR LENGTH(status) <= 128),
  status_updated TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  modified_at TIMESTAMPTZ DEFAULT NOW()
);

-- Diagrams within threat models
diagrams (
  id UUID PRIMARY KEY,
  threat_model_id UUID REFERENCES threat_models(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  type TEXT CHECK (type IN ('DFD-1.0.0')),
  content TEXT,
  cells JSONB,
  svg_image TEXT,
  image_update_vector BIGINT,
  update_vector BIGINT NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  modified_at TIMESTAMPTZ DEFAULT NOW()
);

-- Threats associated with threat models
threats (
  id UUID PRIMARY KEY,  -- UUIDv7 generated by application
  threat_model_id UUID REFERENCES threat_models(id) ON DELETE CASCADE,
  diagram_id UUID REFERENCES diagrams(id) ON DELETE SET NULL,
  cell_id UUID,
  asset_id UUID REFERENCES assets(id) ON DELETE SET NULL,
  name TEXT NOT NULL,
  description TEXT,
  severity TEXT,
  likelihood TEXT,
  risk_level TEXT,
  score DECIMAL(3,1) CHECK (score >= 0.0 AND score <= 10.0),
  priority TEXT DEFAULT 'Medium',
  mitigated BOOLEAN DEFAULT FALSE,
  status TEXT DEFAULT 'Active',
  threat_type TEXT DEFAULT 'Unspecified',
  mitigation TEXT,
  issue_uri TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  modified_at TIMESTAMPTZ DEFAULT NOW()
);

-- Assets being protected
assets (
  id UUID PRIMARY KEY,
  threat_model_id UUID REFERENCES threat_models(id) ON DELETE CASCADE,
  name TEXT NOT NULL CHECK (LENGTH(TRIM(name)) > 0),
  description TEXT,
  type TEXT NOT NULL CHECK (type IN ('data', 'hardware', 'software', 'infrastructure', 'service', 'personnel')),
  criticality TEXT,
  classification TEXT[],
  sensitivity TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  modified_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Access Control
```sql
-- Role-based access control for threat models (supports users and groups)
threat_model_access (
  id UUID PRIMARY KEY,
  threat_model_id UUID REFERENCES threat_models(id) ON DELETE CASCADE,
  user_internal_uuid UUID REFERENCES users(internal_uuid) ON DELETE CASCADE,
  group_internal_uuid UUID REFERENCES groups(internal_uuid) ON DELETE CASCADE,
  subject_type TEXT NOT NULL CHECK (subject_type IN ('user', 'group')),
  role TEXT NOT NULL CHECK (role IN ('owner', 'writer', 'reader')),
  granted_by_internal_uuid UUID REFERENCES users(internal_uuid) ON DELETE SET NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  modified_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT exactly_one_subject CHECK (
    (subject_type = 'user' AND user_internal_uuid IS NOT NULL AND group_internal_uuid IS NULL) OR
    (subject_type = 'group' AND group_internal_uuid IS NOT NULL AND user_internal_uuid IS NULL)
  ),
  UNIQUE NULLS NOT DISTINCT (threat_model_id, user_internal_uuid, subject_type),
  UNIQUE NULLS NOT DISTINCT (threat_model_id, group_internal_uuid, subject_type)
);

-- User groups for authorization
groups (
  internal_uuid UUID PRIMARY KEY,
  provider TEXT NOT NULL,
  group_name TEXT NOT NULL,
  name TEXT,
  description TEXT,
  first_used TIMESTAMPTZ DEFAULT NOW(),
  last_used TIMESTAMPTZ DEFAULT NOW(),
  usage_count INTEGER DEFAULT 1,
  UNIQUE(provider, group_name)
);
```

### Collaboration
```sql
-- Real-time collaboration sessions
collaboration_sessions (
  id UUID PRIMARY KEY,
  threat_model_id UUID REFERENCES threat_models(id) ON DELETE CASCADE,
  diagram_id UUID REFERENCES diagrams(id) ON DELETE CASCADE,
  websocket_url TEXT NOT NULL CHECK (LENGTH(TRIM(websocket_url)) > 0),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ CHECK (expires_at IS NULL OR expires_at > created_at)
);

-- Session participants
session_participants (
  id UUID PRIMARY KEY,
  session_id UUID REFERENCES collaboration_sessions(id) ON DELETE CASCADE,
  user_internal_uuid UUID REFERENCES users(internal_uuid) ON DELETE CASCADE,
  joined_at TIMESTAMPTZ DEFAULT NOW(),
  left_at TIMESTAMPTZ,
  UNIQUE(session_id, user_internal_uuid) WHERE left_at IS NULL
);
```

### Supporting Tables
```sql
-- Documents associated with threat models
documents (
  id UUID PRIMARY KEY,
  threat_model_id UUID REFERENCES threat_models(id) ON DELETE CASCADE,
  name TEXT NOT NULL CHECK (LENGTH(TRIM(name)) > 0),
  uri TEXT NOT NULL CHECK (LENGTH(TRIM(uri)) > 0),
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  modified_at TIMESTAMPTZ DEFAULT NOW()
);

-- Notes associated with threat models
notes (
  id UUID PRIMARY KEY,
  threat_model_id UUID REFERENCES threat_models(id) ON DELETE CASCADE,
  name TEXT NOT NULL CHECK (LENGTH(TRIM(name)) > 0),
  content TEXT NOT NULL CHECK (LENGTH(TRIM(content)) > 0),
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  modified_at TIMESTAMPTZ DEFAULT NOW()
);

-- Repository references
repositories (
  id UUID PRIMARY KEY,
  threat_model_id UUID REFERENCES threat_models(id) ON DELETE CASCADE,
  name TEXT,
  uri TEXT NOT NULL CHECK (LENGTH(TRIM(uri)) > 0),
  description TEXT,
  type TEXT CHECK (type IN ('git', 'svn', 'mercurial', 'other')),
  parameters JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  modified_at TIMESTAMPTZ DEFAULT NOW()
);

-- Flexible key-value metadata for all entities
metadata (
  id UUID PRIMARY KEY,  -- UUIDv7 generated by application
  entity_type TEXT NOT NULL CHECK (entity_type IN ('threat_model', 'threat', 'diagram', 'document', 'repository', 'cell', 'note', 'asset')),
  entity_id UUID NOT NULL,
  key TEXT NOT NULL CHECK (LENGTH(TRIM(key)) > 0 AND LENGTH(key) <= 128 AND key ~ '^[a-zA-Z0-9_-]+$'),
  value TEXT NOT NULL CHECK (LENGTH(TRIM(value)) > 0 AND LENGTH(value) <= 65535),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  modified_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(entity_type, entity_id, key)
);
```

## API Schema Patterns

### Request/Response Schemas
```json
// Standard API response wrapper
{
  "success": boolean,
  "data": object | array | null,
  "error": {
    "code": string,
    "message": string,
    "details": object
  } | null,
  "meta": {
    "timestamp": "ISO 8601 timestamp",
    "request_id": "UUID",
    "pagination": {
      "page": number,
      "limit": number,
      "total": number,
      "pages": number
    } | null
  }
}

// Error response format
{
  "success": false,
  "data": null,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Request validation failed",
    "details": {
      "field": "name",
      "reason": "Field is required"
    }
  }
}
```

### Entity Schemas
```json
// Threat Model schema
{
  "id": "UUID",
  "name": "string (1-200 chars)",
  "description": "string (optional, max 2000 chars)",
  "owner_id": "UUID",
  "created_at": "ISO 8601 timestamp",
  "updated_at": "ISO 8601 timestamp",
  "permissions": {
    "current_user_role": "reader|writer|owner",
    "can_edit": boolean,
    "can_delete": boolean,
    "can_share": boolean
  }
}

// Diagram schema
{
  "id": "UUID",
  "threat_model_id": "UUID",
  "name": "string (1-200 chars)",
  "diagram_data": {
    "cells": [
      {
        "id": "string",
        "type": "process|datastore|external_entity|trust_boundary|data_flow",
        "position": {"x": number, "y": number},
        "size": {"width": number, "height": number},
        "properties": {
          "label": "string",
          "description": "string"
        }
      }
    ],
    "metadata": {
      "version": "string",
      "last_modified_by": "UUID",
      "collaboration_session": "UUID | null"
    }
  },
  "created_at": "ISO 8601 timestamp",
  "updated_at": "ISO 8601 timestamp"
}
```

## WebSocket Message Schemas

### Collaboration Messages
```json
// Diagram operation message
{
  "message_type": "diagram_operation",
  "user_internal_uuid": "UUID",
  "operation_id": "UUID",
  "sequence_number": number,
  "operation": {
    "type": "patch",
    "cells": [
      {
        "id": "string",
        "operation": "add|update|remove",
        "data": object | null
      }
    ]
  },
  "timestamp": "ISO 8601 timestamp"
}

// Presenter mode messages
{
  "message_type": "current_presenter",
  "current_presenter": "UUID",
  "timestamp": "ISO 8601 timestamp"
}

{
  "message_type": "presenter_cursor",
  "user_internal_uuid": "UUID",
  "cursor_position": {"x": number, "y": number},
  "timestamp": "ISO 8601 timestamp"
}

// Session management messages
{
  "event": "join",
  "user_internal_uuid": "UUID",
  "timestamp": "ISO 8601 timestamp"
}

{
  "event": "leave",
  "user_internal_uuid": "UUID",
  "timestamp": "ISO 8601 timestamp"
}

{
  "event": "session_ended",
  "user_internal_uuid": "UUID",
  "message": "string (reason)",
  "timestamp": "ISO 8601 timestamp"
}
```

## Configuration Schemas

### Application Configuration
```yaml
# TMI server configuration schema
server:
  port: "8080"                    # HTTP port
  interface: "0.0.0.0"           # Bind interface
  read_timeout: "30s"            # Request read timeout
  write_timeout: "30s"           # Response write timeout
  idle_timeout: "120s"           # Connection idle timeout
  tls_enabled: false             # Enable HTTPS
  tls_cert_file: ""              # TLS certificate file
  tls_key_file: ""               # TLS private key file

database:
  postgres:
    host: "localhost"            # PostgreSQL host
    port: "5432"                # PostgreSQL port
    user: "postgres"            # Database user
    password: ""                # Database password (env var)
    database: "tmi"             # Database name
    sslmode: "disable"          # SSL mode
  redis:
    host: "localhost"           # Redis host
    port: "6379"               # Redis port
    password: ""               # Redis password (env var)
    db: 0                      # Redis database number

auth:
  jwt:
    secret: ""                 # JWT signing secret (env var)
    expiration_seconds: 3600   # Token expiration
    signing_method: "HS256"    # JWT signing algorithm
  oauth:
    callback_url: "http://localhost:8080/oauth2/callback"
    providers:
      google:
        enabled: true
        client_id: ""          # Google OAuth client ID
        client_secret: ""      # Google OAuth client secret
      github:
        enabled: true
        client_id: ""          # GitHub OAuth client ID
        client_secret: ""      # GitHub OAuth client secret

logging:
  level: "info"              # Log level (debug|info|warn|error)
  is_dev: false             # Development mode logging
  log_dir: "/var/log/tmi"   # Log file directory
  max_age_days: 30          # Log retention days
  max_size_mb: 100          # Log file size limit
  max_backups: 10           # Number of log files to keep
  also_log_to_console: true # Console logging
```

## Redis Schema Patterns

### Key Naming Conventions
```
# Session storage
session:<user_internal_uuid>:<session_id> = {jwt_hash, expires_at, user_data}

# WebSocket connections
ws:connections:<diagram_id> = SET of user_internal_uuids
ws:presenter:<diagram_id> = presenter_user_internal_uuid

# Rate limiting
rate_limit:<user_internal_uuid>:<endpoint> = request_count (TTL: window_duration)

# Collaboration coordination
collab:session:<session_id> = {host_user_internal_uuid, diagram_id, participants}
collab:operations:<session_id> = LIST of operation_events
```

### Data Structure Usage
- **Strings**: Simple key-value pairs for configuration and flags
- **Hashes**: Complex objects like user sessions and collaboration state
- **Sets**: Collections like active connections and participant lists
- **Lists**: Ordered data like operation logs and message queues
- **Sorted Sets**: Time-ordered data like leaderboards and activity feeds

## Schema Validation

### JSON Schema Validation
- **OpenAPI Integration**: API schemas validated with OpenAPI 3.0
- **Request Validation**: Incoming request body validation
- **Response Validation**: Outgoing response structure validation
- **Schema Testing**: Automated schema compliance testing
- **Version Compatibility**: Schema evolution and compatibility checks

### Database Constraints
- **Data Integrity**: Foreign key constraints and referential integrity
- **Business Rules**: CHECK constraints for business logic validation
- **Performance**: Strategic indexing for query optimization
- **Security**: Row-level security and access control constraints

## Schema Evolution

### Migration Strategy
- **Versioned Migrations**: Sequential database schema changes
- **Rollback Capability**: Safe rollback procedures for failed migrations
- **Data Migration**: Data transformation during schema changes
- **Zero-Downtime**: Online schema changes for production systems
- **Testing**: Migration testing in staging environments

### API Versioning
- **Backward Compatibility**: Maintaining API compatibility across versions
- **Deprecation Strategy**: Gradual deprecation of old API versions
- **Schema Registry**: Centralized schema version management
- **Client Migration**: Guidance for client application updates

## Related Documentation

### Implementation References
- [Database Operations](../../operator/database/postgresql-operations.md) - Database management
- [API Documentation](../apis/) - API implementation using these schemas

### Development Integration
- [Client OAuth Integration](../../developer/integration/client-oauth-integration.md) - OAuth client integration
- [Client WebSocket Integration](../../developer/integration/client-websocket-integration-guide.md) - WebSocket client integration

### Architecture Context
- [System Architecture](../architecture/) - Schema design decisions and patterns

This schema documentation serves as the definitive reference for all data structures and formats used throughout the TMI system.

---

## Verification Summary

<!-- Generated: 2025-01-24 -->

### Verified Items

| Item | Status | Notes |
|------|--------|-------|
| `api/models/models.go` | VERIFIED | Single source of truth exists |
| Wiki `Database-Schema-Reference.md` | VERIFIED | Comprehensive schema docs |
| `docs/reference/legacy-migrations/` | VERIFIED | Contains 5 migration files |
| `docs/reference/apis/` | VERIFIED | OpenAPI spec and related files |
| `docs/operator/database/postgresql-operations.md` | VERIFIED | Exists |
| `docs/reference/architecture/` | VERIFIED | Contains README.md and oauth-flow-diagrams.md |
| GORM models for tables | VERIFIED | 25 models in AllModels() |

### Corrections Made

1. **Broken Links Fixed**:
   - Removed reference to non-existent `docs/developer/testing/integration-testing.md`
   - Removed reference to non-existent `docs/developer/integration/client-integration-guide.md`
   - Added links to existing client integration files

### Notes for Content Migration

The detailed SQL schemas, API schemas, WebSocket message schemas, Redis patterns, and configuration schemas documented in this file should be verified against source code before adding to wiki:

1. **SQL Schemas**: Several fields differ between documented SQL and actual GORM models (e.g., `client_credentials` table not documented in SQL examples)
2. **API Response Format**: Documented wrapper format differs from OpenAPI spec
3. **Configuration Schema**: Documented YAML differs from actual `config-development.yml`

**Recommendation**: Use wiki [[Database-Schema-Reference]] as the authoritative human-readable documentation. That wiki page is regularly updated to match `api/models/models.go`.