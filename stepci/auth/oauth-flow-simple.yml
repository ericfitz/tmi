version: "1.1"
name: Simple OAuth Authentication Test
config:
  http:
    baseURL: http://localhost:8080
env:
  auth_token: ""
tests:
  simple_oauth:
    name: Simple OAuth Flow Test
    steps:
      # 1. Initiate OAuth flow 
      - id: start_oauth
        name: Start OAuth flow with user hint
        http:
          url: /auth/login/test?client_callback=http://localhost:8079/&user_hint=testuser
          method: GET
          followRedirects: true
          check:
            status: 200

      # 2. Wait for processing
      - id: wait
        name: Wait for OAuth callback processing
        http:
          url: http://httpbin.org/delay/0.5
          method: GET
          check:
            status: 200

      # 3. Get tokens from stub
      - id: get_tokens
        name: Get tokens from OAuth stub
        http:
          url: http://localhost:8079/latest
          method: GET
          check:
            status: 200
            jsonpath:
              $.flow_type: "implicit"
              $.tokens_ready: true
        captures:
          access_token:
            jsonpath: $.access_token

      # 4. Debug - show what we captured
      - id: debug_token
        name: Debug captured token
        http:
          url: http://httpbin.org/post
          method: POST
          json:
            captured_token: "${{captures.access_token}}"
          check:
            status: 200

      # 5. Test JWT token
      - id: test_token
        name: Test JWT token authentication  
        http:
          url: /auth/me
          method: GET
          headers:
            Authorization: "Bearer ${{captures.access_token}}"
          check:
            status: 200
            jsonpath:
              $.email: "testuser@test.tmi"
              $.authenticated: true